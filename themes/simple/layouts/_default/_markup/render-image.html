{{/* get file that matches the filename as specified as src="" in shortcode */}}
{{ $src := .Page.Resources.GetMatch (printf "*%s*" .Destination) }}
{{ if not $src }}
  {{ $src := resources.Get .Destination }}
{{ end }}

{{ if not $src }}
  {{ $url := .Destination }}
  {{ if hasPrefix $url "//" }}
    {{ $url = printf "https:%s" $url }}
  {{ end }}
  {{fmt.Warnf "URL %s" $url}}
  {{ with resources.GetRemote $url }}
    {{ with .Err }}
      {{ warnf "%s" . }}
    {{ else }}
      {{ $src = . }}
    {{ end }}
  {{ else }}
    {{ errorf "Unable to get remote resource %q" $url }}
  {{ end }}
{{ end }}

{{ $mp4 := .Page.Resources.GetMatch (printf "*%s.mp4" (.Destination)) }}
{{ $webm := .Page.Resources.GetMatch (printf "*%s.webm" (.Destination)) }}
{{ if (or $mp4 $webm) }}
<figure class="">
  <video class="block relative shadow-lg " autoplay muted loop>
    {{ with $webm }}
      <source src="{{.RelPermalink}}" type="video/webm">
    {{end}}
    {{ with $mp4 }}
      <source src="{{.RelPermalink}}" type="video/mp4">
    {{end}}
    {{ with .Title }}
      <figcaption class="text-center -mt-4 text-sm  text-gray-500 ">
        {{ . | markdownify }}
      </figcaption>
    {{ end }}
  </figure>
{{ else }}
  {{ if $src }}
  {{ $s := newScratch }}
  {{ partial "responsive-img-data" (dict "src" $src "scratch" $s) }}

  <figure class="bg-transparent my-6">
    <picture class="block relative hover:shadow-xl hover:shadow-{{$.Page.Scratch.Get "color" }}/20 shadow-lg {{ if gt $src.Height $src.Width }} mx-auto w-2/3{{ end }} img" style="background: url(data:image/webp;base64,{{ ($s.Get "lqip").Content | base64Encode  }}); background-size: cover">
      {{- /* Generate better alt text: use explicit alt, then title, then caption, then generate from context */ -}}
      {{- $altText := "" -}}
      {{- if .Text -}}
        {{ $altText = .Text }}
      {{- else if .Title -}}
        {{ $altText = .Title | plainify }}
      {{- else -}}
        {{- /* Generate descriptive alt from page context */ -}}
        {{- $filename := .Destination | path.Base | replaceRE "\\.[^.]+$" "" | humanize | title -}}
        {{- if $.Page.Title -}}
          {{ $altText = printf "%s - %s" $.Page.Title $filename }}
        {{- else -}}
          {{ $altText = $filename }}
        {{- end -}}
      {{- end -}}
      {{ if $s.Get "has_avif" }}
        <source type="image/avif" srcset="{{ $s.Get "srcset_avif" }}" sizes="(min-width: 48rem) 800px, 100vw">
      {{ end }}
      <img loading="lazy" alt="{{ $altText }}"
        class="cursor-pointer m-0 h-auto w-full lazyload" data-action="zoom"
        {{ if not ($s.Get "is_gif") }}
          srcset="{{ $s.Get "srcset_webp" }}"
          sizes="(min-width: 48rem) 800px, 100vw"
        {{ end }}
        data-zoom-src="{{ ($s.Get "zoom").RelPermalink }}" src="{{ ($s.Get "default").RelPermalink }}" width="{{ ($s.Get "default").Width }}"
        height="{{ ($s.Get "default").Height }}">
    </picture>
    {{ with .Title }}
    <figcaption class="text-center -mt-18 text-sm  text-gray-500 ">
      {{ . | markdownify }}
    </figcaption>
    {{ end }}
  </figure>
  {{ end }}
{{ end }}
